# santamail_install.py (Upload this to GitHub/Gist)

import os,pathlib as p;from pathlib import Path;c='import asyncio, random, discord\nfrom discord import app_commands\nfrom discord.ext import commands, tasks\nfrom ballsdex.core.models import Ball, Player, BallInstance\nfrom ballsdex.core.utils.utils import is_staff\nfrom ballsdex.settings import settings\n\nasync def _is_staff(i):\n    r = is_staff(i)\n    return await r if asyncio.iscoroutine(r) else bool(r)\n\nclass SantaMail(commands.Cog):\n    def __init__(self, bot):\n        self.bot = bot\n        self.santa_loop.start()\n\n    def cog_unload(self):\n        self.santa_loop.cancel()\n\n    @tasks.loop(hours=24)\n    async def santa_loop(self):\n        await self.bot.wait_until_ready()\n        await self._deliver_santa_mail()\n\n    @santa_loop.before_loop\n    async def santa_loop_before(self):\n        await self.bot.wait_until_ready()\n\n    async def _deliver_santa_mail(self, i: discord.Interaction | None = None):\n        e_balls = await Ball.filter(enabled=True)\n        if not e_balls:\n            if i: await i.followup.send("No enabled balls exist.", ephemeral=True)\n            return 0\n\n        players = await Player.all()\n        blist = {int(x) for x in getattr(self.bot, "blacklist", set())}\n        eligible = [p for p in players if p.discord_id not in blist]\n\n        if not eligible:\n            if i: await i.followup.send("No eligible players found.", ephemeral=True)\n            return 0\n\n        chosen = random.sample(eligible, min(5, len(eligible)))\n        results = []\n\n        for p in chosen:\n            reward = random.choice(e_balls)\n            await BallInstance.create(ball=reward, player=p, server_id=None)\n            await self._try_dm(p.discord_id, reward)\n            results.append((p.discord_id, reward.country))\n\n        if i:\n            lines = "\\n".join(f"<@{uid}> ‚Üí **{country}**" for uid, country in results)\n            if not lines: lines = "Nobody received anything."\n            await i.followup.send(f"üéÖ **Santa Mail Sent!**\\n\\n{lines}", ephemeral=True)\n\n        return len(results)\n\n    async def _try_dm(self, uid: int, ball: Ball):\n        u = self.bot.get_user(uid)\n        if u is None:\n            try: u = await self.bot.fetch_user(uid)\n            except Exception: return\n\n        emoji = self.bot.get_emoji(ball.emoji_id)\n        pretty = f"{emoji} {ball.country}" if emoji else ball.country\n\n        e = discord.Embed(\n            title=\"üéÖ Santa‚Äôs Mail\",\n            description=f\"You received a **{pretty}** {settings.collectible_name}! üéÅ\",\n            color=0xff4d4d,\n        )\n        e.set_footer(text=\"Happy Holidays!\")\n\n        try: await u.send(embed=e)\n        except Exception: pass\n\n    @app_commands.command(name=\"santamail\", description=\"Force Santa to deliver gifts right now (admin only).\")\n    @app_commands.check(_is_staff)\n    async def santamail(self, i: discord.Interaction):\n        await i.response.defer(ephemeral=True)\n        await self._deliver_santa_mail(i)\n\n    @santamail.error\n    async def santamail_error(self, i: discord.Interaction, error):\n        if isinstance(error, app_commands.CheckFailure):\n            await i.response.send_message(\"‚ùå You do not have permission to run this command.\", ephemeral=True)\n            return\n        raise error';t='from .cog import SantaMail\nasync def setup(bot):\n    await bot.add_cog(SantaMail(bot))';b=Path("ballsdex/packages/santamail");b.mkdir(parents=True,exist_ok=True);(b/"cog.py").write_text(c);(b/"__init__.py").write_text(t);
